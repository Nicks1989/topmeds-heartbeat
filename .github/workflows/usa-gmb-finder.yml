name: TopMeds USA Buyer Engine (REAL DATA)

on:
  workflow_dispatch:
  schedule:
    - cron: '30 6 * * *'   # Daily 12:00 PM IST

jobs:
  usa:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Harvest USA Pharma Buyers
      run: |
        echo "TOPMEDS USA PHARMA DISTRIBUTORS" > usa-buyers.txt
        echo "--------------------------------" >> usa-buyers.txt

        for page in {1..10}
        do
          curl -s "https://maps.googleapis.com/maps/api/place/textsearch/json?query=pharmaceutical+wholesaler+distributor+USA&key=${{ secrets.GOOGLE_MAPS_KEY }}" > result.json

          jq -r '.results[] | "\(.name) | \(.formatted_address) | \(.place_id)"' result.json >> usa-buyers.txt
        done

    - name: Email Buyer List
      run: |
        python3 - <<EOF
        import smtplib
        from email.message import EmailMessage

        msg = EmailMessage()
        msg['Subject'] = "ðŸ‡ºðŸ‡¸ TOPMEDS â€“ USA Pharmaceutical Distributors"
        msg['From'] = "topmeds02@gmail.com"
        msg['To'] = "topmeds02@gmail.com"

        with open("usa-buyers.txt") as f:
            msg.set_content(f.read())

        s = smtplib.SMTP_SSL("smtp.gmail.com",465)
        s.login("topmeds02@gmail.com","${{ secrets.GMAIL_APP_PASSWORD }}")
        s.send_message(msg)
        s.quit()
        EOF
