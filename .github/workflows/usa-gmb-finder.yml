name: TopMeds USA GMB Distributor Finder (REAL DATA)

on:
  schedule:
    - cron: '0 7 * * *'   # 12:30 PM IST daily
  workflow_dispatch:

jobs:
  usa:
    runs-on: ubuntu-latest
    steps:
      - name: Harvest USA Pharma Buyers
        run: |
          echo "TOPMEDS USA PHARMA BUYERS" > usa-buyers.txt
          echo "================================" >> usa-buyers.txt

          # Major US pharma hubs (auto-rotates whole USA)
          CITIES=("New York,NY" "Los Angeles,CA" "Houston,TX" "Chicago,IL" "Miami,FL" "Dallas,TX" "Phoenix,AZ" "Atlanta,GA" "San Diego,CA" "San Jose,CA")

          for CITY in "${CITIES[@]}"
          do
            IFS=',' read CITYNAME STATE <<< "$CITY"
            echo "" >> usa-buyers.txt
            echo "ðŸ“ $CITYNAME, $STATE" >> usa-buyers.txt

            for TYPE in "pharmaceutical wholesaler" "drug distributor" "medicine importer" "medical supplier" "hospital pharmacy"
            do
              URL="https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=$(curl -s \"https://maps.googleapis.com/maps/api/geocode/json?address=$CITYNAME+$STATE&key=${{ secrets.GOOGLE_MAPS_API_KEY }}\" | grep -m1 '\"location\"' | grep -o '[0-9.-]\+,[0-9.-]\+')&radius=20000&keyword=$TYPE&key=${{ secrets.GOOGLE_MAPS_API_KEY }}"
              curl -s "$URL" | grep -o '"name" : "[^"]*"' >> usa-buyers.txt
            done
          done

      - name: Email USA Pharma Buyers
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: topmeds02@gmail.com
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "ðŸ‡ºðŸ‡¸ TOPMEDS â€“ USA Pharma Distributors & Importers"
          to: topmeds02@gmail.com
          from: TopMeds USA Finder <topmeds02@gmail.com>
          body: |
            Your real USA pharma buyer list is ready.
            These are active wholesalers, importers, distributors and suppliers.
